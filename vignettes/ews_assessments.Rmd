---
title: "Performing Early Warning Signal Assessments"
author: "Duncan O'Brien"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Performing Early Warning Signal Assessments}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>")

```

# About this tutorial

This tutorial introduces how to perform both univariate and multivariate early warning signal (EWS) assessments using `EWSmethods`. It will give examples of rolling and expanding window approaches for univariate data, introduce trait-based composite EWSs and then conclude with an example of multivariate EWSs. 

Greater detail on each function can be found at the [Reference](https://duncanobrien.github.io/EWSmethods/reference/index.html) page.

<br>  

# Getting started

```{r, message=FALSE}
set.seed(123) #to ensure reproducible data

library(EWSmethods)
```

<br>  

## 1. The data

`EWSmethods` comes bundled with two data objects which allow you to practice using the `uniEWS()` and `multiEWS()` functions in both transitioning and non-transitioning data before applying it to your own use case.

`"simTransComms"` contains three replicate datasets of a simulated five species community that has been driven to transition by the introduction of an invasive species (following Dakos 2018). This will be our multivariate dataset when using `multiEWS()` although we may also use each time series in isolation in `uniEWS()`.

`"CODrecovery"` contains three replicate datasets of a simulated cod ( _Gadus morhua_ ) population that transitions from an overfished to a recovered state following the relaxation of fishing pressure. This data was first published by Clements _et al._ 2019. While univariate, `"CODrecovery"` provides extra information on the body size of cod individuals which will improve composite EWSs estimated by `uniEWS()`.

```{r load_data, eval=T}
#Load the two datasets in to the session
data("simTransComms")

data("CODrecovery")
```

We can visualise a community from each of these datasets using the code below:

```{r vis_data,dpi=144, fig.width=4,fig.height=4}
matplot(simTransComms$`1_5_1`[,3:7], type = "l", xlab = "Time", ylab = "Density",  main = "Transitioning five species community")

plot(x = CODrecovery$`1_20`$time, y = CODrecovery$`1_20`$biomass, type="l", xlab = "Year", ylab = "Abundance", main = "Recovering cod population")
```

These plots show that a transition takes place at `time ~= 180` in `"simTransComms$1_5_1"` and `year ~= 2050` in `"CODrecovery$1_20"`. `EWSmethods` helpfully provides this information in each dataset under the `inflection_pt` column.

```{r inflec_data,echo=F}
knitr::kable(data.frame("simTransComms" = simTransComms$`1_5_1`$inflection_pt[1],
"CODrecovery" = 
CODrecovery$`1_20`$inflection_pt[1]))
```

However, EWS assessments are only meaningful if performed on data prior to a transition. As `EWsmethods` provides the time point of transition for both datasets, we can truncate our time series to pre-transition data only. 

```{r trunc_data}
pre_simTransComms <- subset(simTransComms$`1_5_1`,time < inflection_pt)

pre_CODrecovery <- subset(CODrecovery$`1_20`,time < inflection_pt)

```

In reality, EWSs will be assessed in real-time with the presence of past/present tipping points often unknown. If past transitions are known to have occurred, it may be prudent to follow the suggestions of O'Brien & Clements (2021) who show that the occurrence of a historic transition can mask an oncoming event and that only using data post the hisotric transition improves EWS reliability. 

Now the data has been loaded and truncated, it can now be passed to `uniEWS()` and `multiEWS()` to perform EWS assessments.

<br>  

## 2. Univariate EWSs

`EWSmethods` provides two computational approaches to calculate univariate EWSs via the `uniEWS()` function - rolling vs expanding windows. The difference between the two is evident in the figure below but simply, rolling windows estimate EWSs in subsets of the overall time series before 'rolling' on one data point and reassessing, whereas expanding windows add data points sequentially in to an 'expanding' assessment and then standardises against the running mean and standard deviation of the previous window.

```{r figure, echo=F,fig.cap = "Rolling (A) vs expanding (C) window concept diagram. Panels B and D introduce the circumstance when a 'warning' is signalled in both approaches"}
knitr::include_graphics("ewsmethods_eg_fig.png", dpi = 144)
```

<br>  

Both computational approaches can calculate the same EWS indicators however. A brief outline of each can be found in the following table as well as their reference code in `uniEWS()`.

| EWS indicator | Description | `uniEWS()` metric code |
|:------------------------:|------------------------|:------------------------:|
| Standard deviation |	Increasing variance/standard deviation is observed approaching a transition | `"SD"` |
| Coefficient of variation |	Equivalent to SD as is simply SD at time t divided by the mean SD of the time series | `"cv"` |
| Autocorrelation at lag1 |	Autocorrelation (similarity between successive observations) increases approaching a transition. The value of this indicator can be estimated as either the autocorrelation coefficient estimated from a first order autoregressive model or the estimated autocorrelation function at lag1 | `"ar1"` - autoregressive model, `"acf"`- autocorrelation function | 
| Skewness | At a transition, the distribution of values in the time series can become asymmetric | `"skew"` |
| Kurtosis | Kurtosis represents the system reaching more extreme values in the presence of a transition. Due to the increased presence of rare values in the time series, the tails of the observation distribution widen | `"kurt"` |
| Return rate	| The inverse of the first-order term of a fitted autoregressive AR(1) model. Return rate is the primary quantity impacted by CSD – return rate decreases as a tipping point is approached | `"rr"` |
| Density ratio	| Spectral reddening (high variance at low frequencies) occurs near transition. The density ratio quantifies the degree of reddening as the ratio of the spectral density at low frequency to the spectral density at high frequency | `"dr"` |

<br>  

### Rolling windows
The rolling window approach is the most commonly used form of EWS computation due to the work of Dakos *et al* 2012 and the `earlywarnings` package. `uniEWS()` accepts a `method =` and a `winsize =` argument which calls the expanding window method and creates a rolling window `winsize`% of the total time series length.

Lets use an example where we are interested in the autocorrelation, variance and skewness of one of the five species in `pre_simTransComms`. First we supply a dataframe/matrix of n x 2 dimensions (first column is an equally time sequence and the second is the abundance/biomass time series) and the EWS indicator metrics. Then the form of computation, window size and plotting characteristics.

```{r rolling_ews,fig.keep = "none"}
rolling_ews_eg <- uniEWS(data = pre_simTransComms[,c(2,5)],
                         metrics = c("ar1","SD","skew"),
                         method = "rolling",
                         winsize = 50,
                         y_lab = "Density",
                         ggplotIt = TRUE)
```

```{r rolling_ews_fig,dpi=144,fig.width=5,fig.height=6,echo=F}
rolling_ews_eg$plot
```

Note how all EWS indicators begin to trend upwards at `time ~= 170 ` which results in the positive Kendall Tau correlation coefficient indicative of an oncoming transition/tipping point.

<br>  

### Expanding windows
Let's explore the alternative expanding window approach. All we need to change in `uniEWS()` is the `method =` argument, and replace `winsize =` with `burn_in =`. Instead of specifying the size of the rolling window, `burn_in =` dictates the number of datapoints `uniEWS()` is to use to ‘train’ the algorithm. This  mitigates the high number of false-positive signals resulting from the short time series length and high variability when few data points are supplied at the beginning of assessment (O'Brien & Clements, 2021). 

```{r expanding_ews,fig.keep = "none"}
expanding_ews_eg <- uniEWS(data = pre_simTransComms[,c(2,5)],
                         metrics = c("ar1","SD","skew"),
                         method = "expanding",
                         burn_in = 50,
                         threshold = 2,
                         y_lab = "Density",
                         ggplotIt = TRUE)
```

```{r expanding_ews_fig,dpi=144,fig.width=5,fig.height=4,echo=F}
expanding_ews_eg$plot
```

Similar to the rolling window approach, EWS indicators calculated by expanding windows have exceeded the 2σ threshold for more than two consecutive time points and thus identified warnings from `time ~= 170`. However we are more confident in this conclusion as the composite metrics also display this warning. These composite metrics simple sum the standardised individual indicator strengths together and are known to provide a more reliable signal than lone indicators (Clements & Ozgul, 2016).

<br>  

### Trait information
The final contribution by `uniEWS()` is the ability to integrate multiple information sources in the assessment. For example, including body size estimates improves assessment reliability by reducing false positive rate whilst increasing the number of true positives (Clements and Ozgul 2016, Baruah et al. 2020). `uniEWS()` consequently accepts a `trait =` argument where an additional trait time series can be combined with the other abundance-based EWSs as a composite metric. This capability is only available if `method = "expanding"` and `metrics =` contains `"trait"`

```{r trait_ews,fig.keep = "none"}
trait_ews_eg <- uniEWS(data = pre_CODrecovery[,c(2,3)],
                         metrics = c("ar1","SD","trait"),
                         method = "expanding",
                         trait = pre_CODrecovery$mean.size,
                         burn_in = 15, #small burn_in due to shorter time series
                         threshold = 2,
                         y_lab = "Density",
                         trait_lab = "Mean size (g)",
                         ggplotIt = TRUE)
```

```{r trait_ews_fig,dpi=144,fig.width=5,fig.height=4,echo=F}
trait_ews_eg$plot
```

<br>  

## 3. Multivariate EWSs

A brief outline of each can be found in the following table as well as their reference code in `multEWS()`.

| Multivariate EWS indicator | Description | `multEWS()` metric code | Average or dimension reduction technique |
|:-------------:|--------------------------|:-------------:|:-------------:|
| Mean standard deviation |	Average variance across all time series representing the system | `"meanSD"` | Average |
| Max standard deviation |	The variance of the time series with the highest variance of all assessed time series | `"maxSD"` | Average |
| Mean autocorrelation at lag1 |	Average autocorrelation across all time series representing the system | `"meanAR"`  | Average |
| Max autocorrelation at lag1 | The autocorrelation of the time series with the highest autocorrelation of all assessed time series | `"maxAR"` | Average |
| Dominant MAF (maximum autocorrelation factor) eigenvalue | The minimum eigenvalue of the system following MAF dimension reduction | `"eigenMAF"` | Dimension reduction |
| MAF	autocorrelation | The autocorrelation of the data projected on to the first MAF – i.e. the autocorrelation of the first MAF. | `"mafAR"` | Dimension reduction |
| MAF	standard deviation | The variance of the data projected on to the first MAF – i.e. the variance of the first MAF | `"mafSD"` | Dimension reduction |
| First PC (principal component) autocorrelation	| The autocorrelation of the data projected on to the first PC – i.e. the autocorrelation of the first PC | `"pcaAR"` | Dimension reduction |
| First PC standard deviation/ Explained variance | The variance of the data projected on to the first PC – i.e. the variance of the first PC | `"pcaSD"`/`"explSD"` | Dimension reduction |
| First PC 	standard deviation/ Explained variance | The variance of the data projected on to the first PC – i.e. the variance of the first PC | `"pcaSD"`/`"explSD"` | Dimension reduction |
| Dominant eigenvalue of the covariance matrix | The maximum eigenvalue of the covariance matrix between all representative time series | `"eigenCOV"` | Dimension reduction |
| Maximum covariance | The maximum value of the covariance matrix between all representative time series. | `"maxCOV"` | Dimension reduction |

Using `multiEWS()` we can estimate each of these multivariate indicators in the same way as `uniEWS()` - specifying the `method =`, `winsize =`, `burn_in =` etc - but must provide a n x m data.frame/matrix of all representative time series. The first column must again be an equally spaced time sequence.

A rolling window assessment would therefore be coded as such:

```{r multi_ews, fig.keep = "none"}
multi_ews_eg <- multiEWS(data = pre_simTransComms[,2:7],
                         method = "rolling",
                         winsize = 50,
                         ggplotIt = TRUE)
```

```{r multi_ews_fig,dpi=144,fig.width=5,fig.height=5,echo=F}
multi_ews_eg$plot
```

Many of these indicators a postively correlated with time and therefore are 'warnings'.

We could also use expanding windows to achieve a similar result. __Note__ - no composite metric is computed in `multiEWS()` as it is currently unknown how combining multivariate EWS indicators influences prediction reliability.

```{r multi_ews2, fig.keep = "none"}
multi_ews_eg2 <- multiEWS(data = pre_simTransComms[,2:7],
                         method = "expanding",
                         burn_in = 50,
                         threshold = 2,
                         ggplotIt = TRUE)
```

```{r multi_ews2_fig,dpi=144,fig.width=5,fig.height=5,echo=F}
multi_ews_eg2$plot
```

In this circumstance, many of the indicators are warning at different times (e.g. `"eigenMAF"` at `time ~= 65` or `"meanAR"` at `time ~= 100`) but that the vast majority are warning in the last 20 time points. This highlights the usefulness of expanding windows over rolling as the exact time point of warning can be determined. 

<br>  

# FAQ

## 1. How do I interpret EWSs?

### Rolling windows
The simplicity of the rolling window approach also limits its usefulness. A 'warning' is indicated when an EWS displays a strong positive Kendall Tau correlation with time. However, it is unclear what constitutes a 'strong' correlation in this context with published warnings ranging from 0.5 through to 0.9 (Dakos *et al. 2012*, Harris *et al.* 2020, Southall *et al.* 2022). The strength of correlation therefore appears to be context dependent and system specific.

### Expanding windows
Expanding windows have a stronger evidence base for what constitutes a 'warning'. Clements *et al.* 2019 show that two consecutive transgressions of the 2σ threshold reduce false-postive rates and improve the number of true-postives. This has been validated by Southall *et al.* 2022 although they suggest that more than two consecutive signals should be aimed for.

<br>  

## 2. My data is seasonal/contains cycles. Can I still use EWSs?

Early warning signal indicators are particularly sensitive to cyclical data as the repeated non-linearity throughout the year/cycle period will be interpreted as a transition initially, before masking future cycles and tipping points. It is therefore sensible to deseason seasonal data prior to assessment.

`EWSmethods` provides a suite of average and time series decomposition deseasoning techniques via the `deseason_ts()` function. This function takes a n x m data.frame of time series to be deaseasoned. The first column must be a vector of dates with the `increment =` and `order =` arguments indicating the data resolution (year, month, day) and the order of the date vector (ymd/dmy/ydm). The form of deseasoning can then be selected using the `method =` argument. 

Lets create some dummy monthly data that we can deseason.

```{r create_seasonal,dpi=144,fig.width=5,fig.height=4}
spp_data <- matrix(nrow = 5*12, ncol = 5)

spp_data <- sapply(1:dim(spp_data)[2], function(x){

  spp_data[,x] <- rnorm(5*12,mean=20,sd=5)})

multi_spp_data <- cbind("time" = seq(as.Date('2000/01/01'), as.Date('2004/12/01'), by="month"), as.data.frame(spp_data))
  
matplot(x = multi_spp_data$time, y=multi_spp_data[,2:6], type = "l", xlab = "Date", ylab = "Density",  main = "Seasonal five species community")

```

As `multi_spp_data` is random, there are few pronounced cycles but for the sake of this tutorial, `deseason_ts()` would be applied to it as such:

```{r deseason,dpi=144,fig.width=5,fig.height=4}
deseas_dat <- deseason_ts(data = multi_spp_data, increment = "month", method = "stl", order = "ymd")

matplot(x = deseas_dat$date, y=deseas_dat[,2:6], type = "l", xlab = "Date", ylab = "Density",  main = "Deseasoned five species community")
```

The `method = "stl"` argument shows that we have chosen to deseason using LOESS (locally weighted smoothing) by estimating the cyclical component for each time series and then subtracting it. `method = "decompose"/method = "x11"` perform a similar process but use classical decomposition and x11 ARIMA modelling respectively. `method = "average"` is the simplest method where the average increment value is estimated for each unique increment and that value subtracted from each data point that shares that increment key.

In our example, we can see that large monthly values shared across multiple years have been shrunk - e.g. the red dashed species at ~2001 - whereas anomalous values have been maintained - e.g. the green dotted species at ~2003.5.

<br>  

# References

Clements, C.F., McCarthy, M.A. & Blanchard, J.L. (2019) Early warning signals of recovery in complex systems. *Nature Communications*, 10, 1681. [doi:10.1038/s41467-019-09684-y](https://www.nature.com/articles/s41467-019-09684-y)

Kéfi S., Dakos V., Scheffer M., Van Nes E.H. & Rietkerk, M. (2013) Early warning signals also precede non-catastrophic transitions. *Oikos*, 122: 641-648. [doi:10.1111/j.1600-0706.2012.20838.x](https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1600-0706.2012.20838.x) 

<br>  
